<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.staticfile.net/axios/1.6.5/axios.min.js"></script>
  </head>
  <body>
    <input type="file" id="upload" />
    <button id="submit">submit</button>
    <script>
      const btn = document.getElementById('submit');
      const upload = document.getElementById('upload');
      // 每个分片20kb
      const chunkSize = 20 * 1024;

      async function onclick() {
        const file = upload.files?.[0];
        if (!file) return;
        const size = file.size;
        const chunks = [];
        let start = 0;
        while (start < size) {
          chunks.push(file.slice(start, start + chunkSize));
          start += chunkSize;
        }
        const hash = Math.random().toString(16).slice(2, 8);
        // 分片上传
        await Promise.all(
          chunks.map((chunk, index) => {
            const fd = new FormData();
            const separator = '*-*';
            const name = [file.name, hash, index].join(separator);
            fd.set('name', name);
            fd.append('file', chunk);
            return axios.post('/upload', fd);
          }),
        );

        // 合并分片
        await axios.post('/merge', {
          name: file.name,
          hash,
        });
      }

      btn.onclick = onclick;
    </script>
  </body>
</html>
